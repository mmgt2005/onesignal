<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>OneSignal User Tagging</title>
		<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
		<script>
			window.OneSignalDeferred = window.OneSignalDeferred || [];
			OneSignalDeferred.push(async function (OneSignal) {
				const urlParams = new URLSearchParams(window.location.search);
				const appId = urlParams.get("appId");
				const externalID = urlParams.get("externalID");
				
				console.log("OneSignal User Tagging - Parameters:", { appId, externalID });
				
				if (!appId) {
					showError("Missing appId parameter in URL");
					return;
				}
				
				if (!externalID) {
					showError("Missing externalID parameter in URL");
					return;
				}

				try {
					// Initialize OneSignal
					await OneSignal.init({
						appId: appId,
					});
					
					console.log("OneSignal initialized successfully");
					showStatus("Setting up notifications...");
					
					// Check if user is already subscribed
					setTimeout(async () => {
						try {
							const isOptedIn = await OneSignal.User.PushSubscription.getOptedIn();
							
							if (isOptedIn) {
								console.log("User already subscribed, tagging user...");
								await tagUser(externalID);
							} else {
								showStatus("Please allow notifications when prompted...");
							}
						} catch (error) {
							console.error("Error checking subscription status:", error);
						}
					}, 1000);
					
					// Listen for subscription changes
					OneSignal.User.PushSubscription.addEventListener("change", async (event) => {
						console.log("Push subscription change:", event.current.optedIn);
						
						if (event.current.optedIn && !event.previous.optedIn) {
							console.log("User just subscribed! Tagging user...");
							showStatus("Permission granted! Tagging user...");
							
							// Wait a moment for the subscription to fully initialize
							setTimeout(async () => {
								await tagUser(externalID);
							}, 1500);
						}
					});
					
					// Check browser support
					const isPushSupported = OneSignal.Notifications.isPushSupported();
					console.log("Push notifications supported:", isPushSupported);
					
					if (!isPushSupported) {
						showError("Push notifications are not supported on this device/browser");
						return;
					}
					
				} catch (error) {
					console.error("OneSignal initialization error:", error);
					showError("Failed to initialize OneSignal: " + error.message);
				}
			});
			
			async function tagUser(externalID) {
				console.log("Tagging user with external ID:", externalID);
				
				try {
					// Tag the user with the external ID
					OneSignal.User.addTags({ "user_id": externalID });
					console.log("User tagged successfully with user_id:", externalID);
					
					// Show success notification
					showNotification("✅ User successfully tagged!", `You have been tagged with ID: ${externalID}`);
					
					// Close window after a few seconds
					setTimeout(() => {
						console.log("Closing window...");
						window.close();
					}, 3000);
					
				} catch (error) {
					console.error("Error tagging user:", error);
					showError("Failed to tag user: " + error.message);
				}
			}
			
			function showStatus(message) {
				const statusElement = document.getElementById("status-display");
				statusElement.innerHTML = message;
				statusElement.style.display = "block";
			}
			
			function showError(message) {
				const errorElement = document.getElementById("error-display");
				errorElement.innerHTML = message;
				errorElement.style.display = "block";
				console.error(message);
			}
			
			function showNotification(title, message) {
				// Hide other elements
				document.getElementById("status-display").style.display = "none";
				document.getElementById("error-display").style.display = "none";
				const container = document.querySelector(".onesignal-customlink-container");
				if (container) {
					container.style.display = "none";
				}
				
				// Show success notification
				const notificationElement = document.getElementById("notification-display");
				notificationElement.innerHTML = `
					<div style="text-align: center;">
						<div style="font-size: 48px; margin-bottom: 15px;">✅</div>
						<h3 style="margin: 0 0 10px 0; color: #2e7d2e;">${title}</h3>
						<p style="margin: 0; font-size: 16px;">${message}</p>
						<p style="margin-top: 15px; font-size: 14px; color: #666;">This window will close automatically in 3 seconds...</p>
					</div>
				`;
				notificationElement.style.display = "block";
			}
		</script>
	</head>
	<body>
		<div style="padding: 20px; font-family: Arial, sans-serif; max-width: 500px; margin: 0 auto; text-align: center;">
			<h2>Setting up Notifications</h2>
			<p>Please allow notifications to complete the setup process.</p>
			
			<div class="onesignal-customlink-container"></div>
			
			<div id="status-display" style="display: none; margin-top: 20px; padding: 15px; background: #f0f8ff; border: 1px solid #0066cc; border-radius: 8px; color: #0066cc; font-weight: bold;"></div>
			
			<div id="error-display" style="display: none; margin-top: 20px; padding: 15px; background: #ffeaea; border: 1px solid #f44336; border-radius: 8px; color: #c62828; font-weight: bold;"></div>
			
			<div id="notification-display" style="display: none; margin-top: 20px; padding: 30px; background: #e8f5e8; border: 2px solid #4caf50; border-radius: 8px; color: #2e7d2e;"></div>
		</div>
	</body>
</html>
