<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OneSignal External ID Setup</title>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<style>
#success-display, #error-display {
	display: none;
	margin-top: 20px;
	padding: 10px;
	border-radius: 4px;
	opacity: 1;
	transition: opacity 0.5s ease;
}
#success-display {
	background: #e8f5e8;
	border: 1px solid #4caf50;
}
#error-display {
	background: #fdeaea;
	border: 1px solid #f44336;
	color: #c62828;
}
#error-retry {
	margin-top: 10px;
	padding: 8px 16px;
	background: #f44336;
	color: #fff;
	border: none;
	border-radius: 4px;
	cursor: pointer;
}
</style>
<script>
window.OneSignalDeferred = window.OneSignalDeferred || [];
OneSignalDeferred.push(async function (OneSignal) {
	const urlParams = new URLSearchParams(window.location.search);
	const appId = urlParams.get("appId");
	const externalID = urlParams.get("externalID");
	const redirectUrl = urlParams.get("redirectUrl"); // Optional redirect after success

	await OneSignal.init({
		appId: appId,
		autoRegister: false,         // Don't auto-register
		notifyButton: { enable: false } // Hide bell icon
	});

	const successDisplay = document.getElementById("success-display");
	const errorDisplay = document.getElementById("error-display");
	const subscribeBtn = document.getElementById("subscribe-btn");
	const errorRetryBtn = document.getElementById("error-retry");
	const container = document.querySelector(".onesignal-customlink-container");

	async function setExternalIDAndHide() {
		if (!externalID) return;

		try {
			const subscription = await OneSignal.User.PushSubscription.get();
			if (!subscription.optedIn) {
				throw new Error("User not subscribed");
			}

			await OneSignal.User.setExternalId(externalID);

			// Show success
			successDisplay.textContent = "Done! Redirecting...";
			successDisplay.style.display = "block";
			container.style.display = "none";
			subscribeBtn.style.display = "none";
			errorDisplay.style.display = "none";

			// Fade out and redirect
			setTimeout(() => {
				successDisplay.style.opacity = 0;
				setTimeout(() => {
					if (redirectUrl) {
						window.location.href = redirectUrl;
					} else {
						successDisplay.style.display = "none";
					}
				}, 500); // wait for fade-out
			}, 1500);
		} catch (err) {
			console.error("Error setting external ID:", err);
			errorDisplay.style.display = "block";
		}
	}

	// Check if already subscribed
	const subscription = await OneSignal.User.PushSubscription.get();
	if (subscription.optedIn) {
		await setExternalIDAndHide();
	} else {
		// Show subscribe button
		subscribeBtn.style.display = "inline-block";
		subscribeBtn.addEventListener("click", async () => {
			try {
				await OneSignal.User.pushSubscription.request();
				await setExternalIDAndHide();
			} catch (err) {
				console.error("Subscription denied:", err);
				errorDisplay.style.display = "block";
			}
		});
	}

	// Retry button click handler
	errorRetryBtn.addEventListener("click", async () => {
		errorDisplay.style.display = "none";
		await OneSignal.User.pushSubscription.request();
		await setExternalIDAndHide();
	});
});
</script>
</head>
<body>
<div class="onesignal-customlink-container">
	<button id="subscribe-btn" style="display: none; padding: 10px 20px; background: #4caf50; color: #fff; border: none; border-radius: 4px; cursor: pointer;">
		Subscribe
	</button>
</div>

<div id="success-display"></div>

<div id="error-display">
	Notifications are blocked. Please enable them in your browser settings and try again.
	<br />
	<button id="error-retry">Retry</button>
</div>
</body>
</html>
