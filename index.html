<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
		<script>
			window.OneSignalDeferred = window.OneSignalDeferred || [];
			OneSignalDeferred.push(async function (OneSignal) {
				const urlParams = new URLSearchParams(window.location.search);
				const appId = urlParams.get("appId");
				const email = urlParams.get("email");
				const rowid = urlParams.get("rowid");
				
				await OneSignal.init({
					appId: appId,
				});

				let subscriptionConfirmed = false;
				let storedSubscriptionId = null;
				
				// Function to show the Next button
				function showNextButton() {
					console.log("Showing Next button - current stored ID:", storedSubscriptionId);
					document.getElementById("success-display").textContent = "Great! Push notifications are enabled. Click 'Next' to continue.";
					document.getElementById("success-display").style.background = "#e3f2fd";
					document.getElementById("success-display").style.borderColor = "#2196f3";
					document.getElementById("success-display").style.display = "block";
					document.getElementById("next-button").style.display = "block";
					
					const customLinkContainer = document.querySelector(".onesignal-customlink-container");
					if (customLinkContainer) {
						customLinkContainer.style.display = "none";
					}
				}
				
				// Function to manually send webhook
				async function sendWebhookManually() {
					console.log("=== MANUAL WEBHOOK SEND ===");
					console.log("Stored subscription ID:", storedSubscriptionId);
					
					try {
						let subscriptionId = storedSubscriptionId;
						
						// If we don't have stored ID, try the API methods with retry
						if (!subscriptionId) {
							console.log("No stored ID, trying API methods with retries...");
							
							for (let attempt = 1; attempt <= 5; attempt++) {
								console.log(`Attempt ${attempt} to get subscription ID...`);
								
								// Method 1: Try getting push subscription
								try {
									const pushSubscription = await OneSignal.User.PushSubscription.getById();
									if (pushSubscription && pushSubscription.id) {
										subscriptionId = pushSubscription.id;
										console.log("SUCCESS - Push subscription:", pushSubscription);
										break;
									}
								} catch (e) {
									console.log("Push subscription method failed:", e);
								}
								
								// Method 2: Try getting OneSignal user ID
								if (!subscriptionId) {
									try {
										const userId = await OneSignal.User.getOnesignalId();
										if (userId) {
											subscriptionId = userId;
											console.log("SUCCESS - OneSignal user ID:", userId);
											break;
										}
									} catch (e) {
										console.log("User ID method failed:", e);
									}
								}
								
								// Wait before next attempt
								if (!subscriptionId && attempt < 5) {
									console.log("Waiting 2 seconds before next attempt...");
									await new Promise(resolve => setTimeout(resolve, 2000));
								}
							}
						}
						
						console.log("FINAL subscription ID for webhook:", subscriptionId);
						
						if (subscriptionId) {
							const webhookUrl = "https://go.glideapps.com/api/container/plugin/webhook-trigger/LPCunXsYkOiRLSxXBhSH/2da69580-f8b2-40a1-91a6-a131887981bf";
							
							const webhookData = {
								rowid: rowid,
								email: email,
								subscriptionId: subscriptionId
							};
							
							console.log("Sending webhook with data:", webhookData);
							
							const response = await fetch(webhookUrl, {
								method: "POST",
								headers: {
									"Content-Type": "application/json",
								},
								body: JSON.stringify(webhookData),
							});
							
							console.log("Webhook response status:", response.status);
							
							// Handle both JSON and text responses
							let responseData;
							const contentType = response.headers.get("content-type");
							console.log("Response content-type:", contentType);
							
							try {
								if (contentType && contentType.includes("application/json")) {
									responseData = await response.json();
								} else {
									responseData = await response.text();
								}
								console.log("Webhook response data:", responseData);
							} catch (parseError) {
								console.log("Could not parse response, treating as success:", parseError);
								responseData = "Response received successfully";
							}
							
							if (response.ok) {
								document.getElementById("success-display").textContent = "Done! Subscription sent to webhook.";
								document.getElementById("success-display").style.background = "#e8f5e8";
								document.getElementById("success-display").style.borderColor = "#4caf50";
								document.getElementById("success-display").style.display = "block";
								document.getElementById("next-button").style.display = "none";
								document.querySelector(".onesignal-customlink-container").style.display = "none";
							} else {
								throw new Error(`Webhook failed with status: ${response.status}`);
							}
							
						} else {
							console.log("ERROR: No subscription ID found after all attempts");
							throw new Error("No subscription ID found after all attempts");
						}
						
					} catch (error) {
						console.error("Manual webhook error:", error);
						document.getElementById("success-display").textContent = "Could not retrieve subscription ID. Please try again or refresh the page.";
						document.getElementById("success-display").style.background = "#fbe8e8";
						document.getElementById("success-display").style.borderColor = "#d32f2f";
						document.getElementById("success-display").style.display = "block";
					}
				}
				
				// Add click listener for next button
				document.getElementById("next-button").addEventListener("click", sendWebhookManually);
				
				// Event 1: PushSubscription change
				OneSignal.User.PushSubscription.addEventListener("change", (event) => {
					console.log("=== PUSHSUBSCRIPTION CHANGE EVENT ===");
					console.log("event.current.optedIn:", event.current.optedIn);
					console.log("event.current.id:", event.current.id);
					
					// Store the ID if it exists
					if (event.current.id) {
						storedSubscriptionId = event.current.id;
						console.log("STORED subscription ID from PushSubscription change:", storedSubscriptionId);
					}
					
					if (event.current.optedIn && !subscriptionConfirmed) {
						subscriptionConfirmed = true;
						showNextButton();
					}
				});
				
				// Event 2: User change event
				OneSignal.User.addEventListener("change", (event) => {
					console.log("=== USER CHANGE EVENT ===");
					console.log("event.current:", event.current);
					if (event.current.onesignalId) {
						storedSubscriptionId = event.current.onesignalId;
						console.log("STORED subscription ID from User change:", storedSubscriptionId);
					}
				});
				
				// Event 3: Permission change
				try {
					OneSignal.Notifications.addEventListener("permissionChange", async (granted) => {
						console.log("=== PERMISSION CHANGE EVENT ===");
						console.log("Permission granted:", granted);
						
						if (granted) {
							// Wait a bit for subscription to be created
							setTimeout(async () => {
								try {
									const pushSub = await OneSignal.User.PushSubscription.getById();
									const userId = await OneSignal.User.getOnesignalId();
									console.log("After permission - pushSub:", pushSub);
									console.log("After permission - userId:", userId);
									
									if (pushSub && pushSub.id) {
										storedSubscriptionId = pushSub.id;
										console.log("STORED subscription ID from permission change:", storedSubscriptionId);
									} else if (userId) {
										storedSubscriptionId = userId;
										console.log("STORED user ID from permission change:", storedSubscriptionId);
									}
									
									if (!subscriptionConfirmed && granted) {
										subscriptionConfirmed = true;
										showNextButton();
									}
								} catch (e) {
									console.log("Error getting subscription after permission:", e);
								}
							}, 2000);
						}
					});
				} catch (e) {
					console.log("Could not add permission listener:", e);
				}
			});
		</script>
	</head>
	<body>
		<div class="onesignal-customlink-container"></div>
		<div id="success-display" style="display: none; margin-top: 20px; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px"></div>
		
		<!-- Next button for manual webhook sending -->
		<button id="next-button" style="display: none; margin-top: 10px; padding: 10px 20px; border: none; border-radius: 4px; background-color: #007bff; color: white; cursor: pointer; font-size: 16px;">
			Next
		</button>
	</body>
</html>
