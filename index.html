<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>
		<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
		<script>
			window.OneSignalDeferred = window.OneSignalDeferred || [];
			OneSignalDeferred.push(async function (OneSignal) {
				const urlParams = new URLSearchParams(window.location.search);
				const appId = urlParams.get("appId");
				const email = urlParams.get("email");

				await OneSignal.init({
					appId: appId,
				});

				try {
					const pushSubscription = await OneSignal.User.PushSubscription.getById();
					const subscriptionId = pushSubscription ? pushSubscription.id : null;

					if (subscriptionId) {
						const webhookUrl = "https://go.glideapps.com/api/container/plugin/webhook-trigger/LPCunXsYkOiRLSxXBhSH/2da69580-f8b2-40a1-91a6-a131887981bf";
						fetch(webhookUrl, {
							method: "POST",
							headers: {
								"Content-Type": "application/json",
							},
							body: JSON.stringify({
								subscriptionId: subscriptionId,
								email: email,
							}),
						})
							.then((response) => {
								if (response.ok) {
									console.log("Success: Webhook call successful.");
									document.getElementById("success-display").textContent = "Done! Subscription successful. Please close this window.";
									document.getElementById("success-display").style.display = "block";
									document.querySelector(".onesignal-customlink-container").style.display = "none";
								} else {
									throw new Error(`HTTP error! status: ${response.status}`);
								}
							})
							.catch((error) => {
								console.error("Error:", error);
								document.getElementById("success-display").textContent = "An error occurred. Please try again.";
								document.getElementById("success-display").style.background = "#fbe8e8";
								document.getElementById("success-display").style.borderColor = "#d32f2f";
								document.getElementById("success-display").style.display = "block";
							});
					} else {
						console.warn("Subscription ID not found.");
					}
				} catch (error) {
					console.error("A subscription error occurred:", error);
					document.getElementById("success-display").textContent = "Please enable push notifications to continue.";
					document.getElementById("success-display").style.background = "#fff3e0";
					document.getElementById("success-display").style.borderColor = "#ff9800";
					document.getElementById("success-display").style.display = "block";
				}
			});
		</script>
	</head>
	<body>
		<div class="onesignal-customlink-container"></div>
		<div id="success-display" style="display: none; margin-top: 20px; padding: 10px; background: #e8f5e8; border: 1px solid #4caf50; border-radius: 4px"></div>
	</body>
</html>
